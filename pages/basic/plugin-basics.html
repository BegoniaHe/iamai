<!doctype html>
<html class="no-js" lang="en" data-content_root="">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><link rel="next" title="Built-in Messages" href="builtin-message.html" /><link rel="prev" title="Basic Configuration" href="basic-config.html" />

    <link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/retrofor/iamai@master/docs/public/retro.png"/><!-- Generated with Sphinx 7.1.2 and Furo 2023.09.10 -->
        <title>Plugin Basics - Who am i? iamai. documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=36a5483c" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/fontawesome.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/brands.min.css" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<div class="announcement">
  <aside class="announcement-content">
     Wiki is under construction, welcome any contribution! 
  </aside>
</div>

<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">Who am i? iamai.  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="https://cdn.jsdelivr.net/gh/retrofor/iamai@master/docs/public/retro.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">Who am i? iamai.  documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../starting/getting-started.html">Quick Start</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Basic</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="basic-config.html">Basic Configuration</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Plugin Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="builtin-message.html">Built-in Messages</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../advanced/plugin-advanced.html">Advanced Plugin Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/hot-reload.html">Hot Reload</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/scheduler.html">Scheduled Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/hook-function.html">Hook Functions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Adapters</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../adapters/cqhttp-adapter.html">CQHTTP Protocol Adapter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../adapters/mirai-adapter.html">Mirai Protocol Adapter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../adapters/dingtalk-adapter.html">DingTalk Protocol Adapter</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="edit-this-page">
  <a class="muted-link" href="https://github.com/retrofor/iamai/edit/master/docs/pages/basic/plugin-basics.md" title="Edit this page">
    <svg aria-hidden="true" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <path d="M4 20h4l10.5 -10.5a1.5 1.5 0 0 0 -4 -4l-10.5 10.5v4" />
      <line x1="13.5" y1="6.5" x2="17.5" y2="10.5" />
    </svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="plugin-basics">
<h1>Plugin Basics<a class="headerlink" href="#plugin-basics" title="Permalink to this heading">#</a></h1>
<section id="loading-plugins">
<h2>Loading Plugins<a class="headerlink" href="#loading-plugins" title="Permalink to this heading">#</a></h2>
<p>In the <a class="reference internal" href="#./getting-started.md"><span class="xref myst">Getting Started</span></a> chapter, we created a <code class="docutils literal notranslate"><span class="pre">plugins</span></code> directory and set it as the plugin directory in the configuration file. Any Python modules placed in the plugins directory (except those starting with _) will be automatically loaded and tested as plugins. Alternatively, you can load plugins “programmatically” without configuring <code class="docutils literal notranslate"><span class="pre">plugin_dirs</span></code> using the following methods.</p>
<p>However, in most cases, you do not need to use the methods below, and it is recommended to load plugins through the configuration options <code class="docutils literal notranslate"><span class="pre">plugin_dirs</span></code> or <code class="docutils literal notranslate"><span class="pre">plugins</span></code>.</p>
</section>
<section id="loading-plugin-directories">
<h2>Loading Plugin Directories<a class="headerlink" href="#loading-plugin-directories" title="Permalink to this heading">#</a></h2>
<p>Add the following lines in the <code class="docutils literal notranslate"><span class="pre">main.py</span></code> file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="kn">from</span> <span class="nn">iamai</span> <span class="kn">import</span> <span class="n">Bot</span>

<span class="n">bot</span> <span class="o">=</span> <span class="n">Bot</span><span class="p">()</span>
<span class="n">bot</span><span class="o">.</span><span class="n">load_plugins_from_dirs</span><span class="p">([</span><span class="s2">&quot;plugins&quot;</span><span class="p">,</span> <span class="s2">&quot;/home/xxx/iamai/plugins&quot;</span><span class="p">])</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">bot</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

</pre></div>
</div>
<p>This is actually the same as configuring plugin_dirs to [“plugins”, “/home/xxx/iamai/plugins”]. The directories can be relative paths or absolute paths. Plugins starting with _ will not be loaded.</p>
</section>
<section id="loading-individual-plugins">
<h2>Loading Individual Plugins<a class="headerlink" href="#loading-individual-plugins" title="Permalink to this heading">#</a></h2>
<p>Add the following lines in the <code class="docutils literal notranslate"><span class="pre">main.py</span></code> file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="kn">from</span> <span class="nn">iamai</span> <span class="kn">import</span> <span class="n">Bot</span>

<span class="k">class</span> <span class="nc">TestPlugin</span><span class="p">(</span><span class="n">Plugin</span><span class="p">):</span>
   <span class="k">pass</span>

<span class="n">bot</span> <span class="o">=</span> <span class="n">Bot</span><span class="p">()</span>
<span class="n">bot</span><span class="o">.</span><span class="n">load_plugins</span><span class="p">(</span><span class="s2">&quot;plugins.hello&quot;</span><span class="p">,</span> <span class="n">TestPlugin</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
   <span class="n">bot</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">load_plugins</span></code> method can take a plugin class, a string, or a <code class="docutils literal notranslate"><span class="pre">pathlib.Path</span></code> object. If it’s the latter two, it will be considered as the name of the plugin module (in the same format as Python’s <code class="docutils literal notranslate"><span class="pre">import</span></code> statement) and the path of the plugin module file, respectively.</p>
</section>
<section id="writing-plugins">
<h2>Writing Plugins<a class="headerlink" href="#writing-plugins" title="Permalink to this heading">#</a></h2>
<p>Each plugin is a plugin class.</p>
<p>Although not mandatory, it is recommended to place each plugin class in a separate Python module.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>.
├── plugins
│   ├── a.py (single Python file)
│   └── b (Python package)
│      └── __init__.py
├── config.toml
└── main.py
</pre></div>
</div>
<p>Plugin classes must be subclasses of the Plugin class and must implement the <code class="docutils literal notranslate"><span class="pre">rule()</span></code> and <code class="docutils literal notranslate"><span class="pre">handle()</span></code> methods.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="kn">from</span> <span class="nn">iamai</span> <span class="kn">import</span> <span class="n">Plugin</span>


<span class="k">class</span> <span class="nc">TestPlugin</span><span class="p">(</span><span class="n">Plugin</span><span class="p">):</span>
    <span class="n">priority</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">block</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">rule</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

</pre></div>
</div>
<p>While the class name <code class="docutils literal notranslate"><span class="pre">TestPlugin</span></code> is not mandatory, it is recommended to use meaningful names for better readability.</p>
<p>The priority attribute represents the priority of the plugin, where a smaller number indicates a higher priority.</p>
<p>The block attribute determines whether to stop event propagation after the current plugin is executed. If set to <code class="docutils literal notranslate"><span class="pre">True</span></code>, event propagation will stop after the current plugin completes, and plugins with lower priorities will not be executed.</p>
<p>Both priority and block are optional, and their default values are 0 and False, respectively.</p>
<p>As mentioned in the section <a class="reference internal" href="#"><span class="xref myst">How Does it Work?</span></a>, when an adapter generates an event (e.g., the robot receives a message), the event will be dispatched to various plugins based on their priorities. iamai will then execute the rule() method of each plugin one by one to determine whether the handle() method should be executed.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Plugin</span></code> class has built-in attributes and methods:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">self.event</span></code>: The event currently being processed by this plugin.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self.name</span></code>: The name of the plugin class.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self.bot</span></code>: The robot object.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self.config</span></code>: The plugin configuration.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self.state</span></code>: The plugin state.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self.stop()</span></code>: Stops the current event propagation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self.skip()</span></code>: Skips itself and continues event propagation.
All attributes and methods except for <code class="docutils literal notranslate"><span class="pre">self.event</span></code> will be discussed in detail in the section <a class="reference internal" href="#./plugin-advanced"><span class="xref myst">Advanced Plugins</span></a> .</p></li>
</ul>
<p>Different adapters generate different events. In the following example, we will write a “Hello” plugin using the CQHTTP adapter.</p>
</section>
<section id="writing-the-rule-method">
<h2>Writing the <code class="docutils literal notranslate"><span class="pre">rule()</span></code> Method<a class="headerlink" href="#writing-the-rule-method" title="Permalink to this heading">#</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="kn">from</span> <span class="nn">iamai</span> <span class="kn">import</span> <span class="n">Plugin</span>

<span class="k">class</span> <span class="nc">Halloiamai</span><span class="p">(</span><span class="n">Plugin</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">rule</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">adapter</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;cqhttp&quot;</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;message&quot;</span>
            <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;hello&quot;</span>
        <span class="p">)</span>

</pre></div>
</div>
<p>If you find putting all the conditions in one line less readable, you can write it like this:</p>
<div class="highlight-python{9-13} notranslate"><div class="highlight"><pre><span></span>
from iamai import Plugin


class Halloiamai(Plugin):
    async def handle(self) -&gt; None:
        pass

    async def rule(self) -&gt; bool:
        if self.event.adapter.name != &quot;cqhttp&quot;:
            return False
        if self.event.type != &quot;message&quot;:
            return False
        return str(self.event.message).lower() == &quot;hello&quot;

</pre></div>
</div>
<p>As different adapters generate different events, you should first check the name of the adapter that generated the current event.</p>
<p>Then, check the type of the current event. For CQHTTP adapter, the event types are <code class="docutils literal notranslate"><span class="pre">message</span></code>, <code class="docutils literal notranslate"><span class="pre">notice</span></code>, and <code class="docutils literal notranslate"><span class="pre">request</span></code>, where only message type has the <code class="docutils literal notranslate"><span class="pre">message</span></code> attribute. This plugin only responds to message events.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">message</span></code> attribute of CQHTTP adapter message events represents the received message and is of type <code class="docutils literal notranslate"><span class="pre">CQHTTPMessage</span></code>, which is a subclass of the built-in Message class in iamai.</p>
<p>The built-in Message class in iamai implements many useful methods. It is recommended that all adapter developers use it as much as possible. Specific usage is mentioned in the <a class="reference internal" href="#./plugin-advanced.md"><span class="xref myst">Advanced Plugins</span></a> section. Here, you can directly use the <code class="docutils literal notranslate"><span class="pre">str()</span></code> function to convert the Message object <code class="docutils literal notranslate"><span class="pre">self.event.message</span></code> to a string.</p>
<p>In addition, commonly used methods in the <code class="docutils literal notranslate"><span class="pre">rule()</span></code> method are <code class="docutils literal notranslate"><span class="pre">self.event.message.startswith('xxx')</span></code> and <code class="docutils literal notranslate"><span class="pre">self.event.message.endswith('xxx')</span></code>, which are equivalent to the <code class="docutils literal notranslate"><span class="pre">startswith()</span></code> and <code class="docutils literal notranslate"><span class="pre">endswith()</span></code> methods of strings.</p>
</section>
<section id="writing-the-handle-method">
<h2>Writing the <code class="docutils literal notranslate"><span class="pre">handle()</span></code> method<a class="headerlink" href="#writing-the-handle-method" title="Permalink to this heading">#</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="kn">from</span> <span class="nn">iamai</span> <span class="kn">import</span> <span class="n">Plugin</span>


<span class="k">class</span> <span class="nc">Halloiamai</span><span class="p">(</span><span class="n">Plugin</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Hello, iamai!&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">rule</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">adapter</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;cqhttp&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;hello&quot;</span>

</pre></div>
</div>
<p>As mentioned above, when the rule() method returns <code class="docutils literal notranslate"><span class="pre">True</span></code>, the <code class="docutils literal notranslate"><span class="pre">handle()</span></code> method will be called. Here, we used a method of the message event, <code class="docutils literal notranslate"><span class="pre">reply()</span></code>, to quickly reply to the current message without specifying the recipient of the message.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">reply()</span></code> method is an asynchronous method, so you must use <code class="docutils literal notranslate"><span class="pre">await</span></code> when calling it to wait for it to return.</p>
<p>Now let’s look at another example to learn more usage.</p>
</section>
<section id="example-weather-plugin">
<h2>Example : Weather Plugin<a class="headerlink" href="#example-weather-plugin" title="Permalink to this heading">#</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">iamai</span> <span class="kn">import</span> <span class="n">Plugin</span>
<span class="kn">from</span> <span class="nn">iamai.exceptions</span> <span class="kn">import</span> <span class="n">GetEventTimeout</span>


<span class="k">class</span> <span class="nc">Weather</span><span class="p">(</span><span class="n">Plugin</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">get_plain_text</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_weather</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Please enter the city you want to query:&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">city_event</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">adapter</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">GetEventTimeout</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_weather</span><span class="p">(</span><span class="n">city_event</span><span class="o">.</span><span class="n">get_plain_text</span><span class="p">())</span>
                <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">rule</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">adapter</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;cqhttp&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;weather&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_weather</span><span class="p">(</span><span class="n">city</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">city</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Beijing&quot;</span><span class="p">,</span> <span class="s2">&quot;Shanghai&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="s2">&quot;The city you want to query is not supported yet!&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;The weather in </span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2"> is...&quot;</span>


</pre></div>
</div>
<p>You can send a message to the robot in the format weather Beijing to get the weather information for Beijing. Alternatively, you can just send weather, and the robot will ask you for the city to query, then you can send the name of the city to query the weather.</p>
<p>In this example, the plugin needs to get the next received message. We use the get() method for this, which is used to obtain events that meet certain conditions. It is also an asynchronous method, so use await to wait for it.</p>
<p>Note that the get() method can specify a timeout to avoid waiting for events indefinitely. When a timeout occurs, it will raise the iamai.exception.GetEventTimeout exception. Be sure to handle this situation properly.</p>
<p>Also, the get_weather() method here does not actually fetch real weather data. You can use any weather API, but when making network requests, use asynchronous libraries like aiohttp or httpx, rather than synchronous ones like requests, to avoid blocking the program.</p>
<p>By reading up to this point, you should be able to write an iamai plugin. Next, we suggest you continue reading Advanced Plugins and the tutorial for the adapter you are going to use.</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="builtin-message.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Built-in Messages</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="basic-config.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Basic Configuration</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023, retrofor.
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link fa-brands fa-github fa-2x" href="https://github.com/retrofor/iamai/" aria-label="GitHub"></a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Plugin Basics</a><ul>
<li><a class="reference internal" href="#loading-plugins">Loading Plugins</a></li>
<li><a class="reference internal" href="#loading-plugin-directories">Loading Plugin Directories</a></li>
<li><a class="reference internal" href="#loading-individual-plugins">Loading Individual Plugins</a></li>
<li><a class="reference internal" href="#writing-plugins">Writing Plugins</a></li>
<li><a class="reference internal" href="#writing-the-rule-method">Writing the <code class="docutils literal notranslate"><span class="pre">rule()</span></code> Method</a></li>
<li><a class="reference internal" href="#writing-the-handle-method">Writing the <code class="docutils literal notranslate"><span class="pre">handle()</span></code> method</a></li>
<li><a class="reference internal" href="#example-weather-plugin">Example : Weather Plugin</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../_static/scripts/furo.js?v=32e29ea5"></script>
    </body>
</html>